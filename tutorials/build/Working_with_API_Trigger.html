<!DOCTYPE html>
<html>
<title>WALKOFF-Automation for All</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
<style>

body,h1,h2,h3,h4,h5,h6 {font-family: "Lato", sans-serif}
.w3-navbar,h1,button {font-family: "Montserrat", sans-serif}
.fa-graduation-cap,.fa-flask{font-size:200px}

#headerDiv{
    background-image:url("../../files/images/headerBackground2.png");
    background-size: 50% auto;
    background-repeat: no-repeat;
    background-position:50% 50%;
}

.imageList {
  list-style-type: none;
}

.topLevelList + h5{
  display:none;
}

.fa-circle, .fa-circle-o{
  font-size:12px;
  padding-right:10px;
}

.code{
    background-color:#edf0f4;
    padding:25px;
}


td{
    padding-right:10px;
    margin-bottom: 25px;
    margin-top:25px;
}

.image{
    text-align:center;
}

.image img{
    max-width:100%;
    max-height:100%;
}

.functionality_list li{
    margin-bottom:20px;
}

.tag{
    background-color:#edf0f4;
    text-align:center;
}

img.media-object.image{
    width:100%;
}

.tutorialTable td{
    border-bottom:1px solid black;
}

</style>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
    
<!-- Navbar -->
<div class="w3-top">
  <div class="w3-bar w3-blue-grey w3-card-2 w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-opennav w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
    <a href="../../index.html" class="w3-bar-item w3-button w3-padding-large w3-white">Home</a>
    <a href="../../documentation/build/index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Documentation</a>
    <a href="https://github.com/nsacyber/WALKOFF" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Source</a>
    <a href="../../swagger/index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">API</a>
    <a href="index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Tutorials</a>
  </div>

  <!-- Navbar on small screens -->
  <div id="navDemo" class="w3-navblock w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
    <a class="w3-padding-large" href="../../documentation/build/index.html">Documentation</a>
    <a class="w3-padding-large" href="https://github.com/nsacyber/WALKOFF">Source</a>
    <a class="w3-padding-large" href="../../swagger/index.html">API</a>
    <a class="w3-padding-large" href="index.html">Tutorials</a>
  </div>
</div>

<!-- Header -->
<header id="headerDiv" class="w3-container w3-black w3-center w3-padding-64">
  <h1 class="headerText w3-margin w3-jumbo">WALKOFF</h1>
  <h5 class="headerText w3-margin w3-xxxlarge">Tutorials</h5>
</header>

<div class="w3-row-padding w3-padding-64 w3-container">
  <div class="w3-content">
    <div class="w3-twothird">
      <h1>Using the WALKOFF API (Triggers)</h1>
        <p>One of the primary uses of the WALKOFF API will be to execute workflows and send data to actions in workflows that are awaiting data. In this part of the WALKOFF API tutorial, having authenticated with the WALKOFF instance and verified the existence of our workflow, we will execute it, send data to a trigger, and check the results of the workflow execution.</p>
        <p>At the end of this tutorial series, we will have developed a script that:</p>
        <ol>
            <li>Takes in address and username arguments for a WALKOFF instance.</li>
            <li>Attempts to authenticate with the WALKOFF instance at that address with the specified username, prompting for a password.</li>
            <li>Refreshs the access token.</li>
            <li>Lists the available workflows.</li>
            <li>If the playbook "Tutorials" has a workflow "Triggers", executes it.</li>
            <li>Using the resulting <code>execution_uid</code>, provides data to any triggers waiting in that workflow.
            <li>Checks the results of the workflow.</li>
            <li>Logs out.</li>
        </ol>
        <p>This part will detail steps 5, 6, and 7.</p>
        <h4><b>1. Execute a workflow.</b></h4>
        <p>To execute a workflow, we'll POST to the <code> /api/playbooks/{playbook_name}/workflows/{workflow_name}/execute </code> endpoint.</p>
        <pre><code class="python">
def execute_workflow(self, playbook_name, workflow_name):
    execution_uid = None
    if self.is_connected:
        print("Executing workflow..."),
        ep = "/api/playbooks/{}/workflows/{}/execute".format(
            playbook_name, workflow_name)

        r = requests.post(self.address + ep,
                          headers=self.auth_header,
                          json={},
                          timeout=2)

        if r.status_code == 202:
            execution_uid = r.json()["id"]
            print("{}:{} was executed: {}".format(
                playbook_name, workflow_name, execution_uid))

        elif r.status_code == 461:
            print("Playbook or workflow does not exist.")

        else:
            print("Unknown response: {}: {}".format(
                r.status_code, r.json()))

    return execution_uid
        </code></pre>
        <p>The endpoint takes the playbook name and workflow name in the URI, and optionally takes a starting action as data. If the workflow successfully begins executing, it will return the <code>execution_uid</code> for that run, which can be used to further interact with it.</p>
        <h4><b>2. Trigger an action awaiting data</b></h4>
        <p>To trigger an action, we'll POST to the <code> /api/triggers/send_data </code> endpoint.</p>
        <pre><code class="python">
def trigger(self, execution_uids, data):
    success = False
    if self.is_connected:
        print("Triggering action..."),

        r = requests.post(self.address + "/api/triggers/send_data",
                          headers=self.auth_header,
                          json=dict(execution_uids=execution_uids,
                                    data_in=data),
                          timeout=2)

        if r.status_code == 200:
            success = True
            print("{} was triggered".format(
                execution_uids))

        else:
            print("Unknown response: {}: {}".format(
                r.status_code, r.json()))

    return success
        </code></pre>
        <p>The endpoint takes an object with a list of <code>execution_uids</code> to target, and the data to pass to actions awaiting input in those workflows. The data will be evaluated by a trigger condition set on that action, which is detailed <a href="Develop_conditions_transforms.html">here.</a></p>
        <h4><b>3. Check workflow results</b></h4>
        <p>To retrieve the results of a workflow, query the <code> /api/workflowresults/{execution_uid} </code> endpoint.</p></p>
        <pre><code class="python">
def check_result(self, execution_uid):
    success = False
    if self.is_connected:
        print("Checking results..."),

        ep = "/api/workflowresults/{}".format(
            execution_uid)

        r = requests.get(self.address + ep,
                         headers=self.auth_header,
                         timeout=2)

        if r.status_code == 200:
            success = True
            print("Results of {}: {}".format(
                execution_uid, r.json()))

        else:
            print("Unknown response: {}: {}".format(
                r.status_code, r.json()))

    return success
        </code></pre>
        <p>The <code>/api/workflowresults/{execution_uid}</code> endpoint takes the <code>execution_uid</code> for the targeted workflow run in the URI, and returns an object with all execution details and results from that run.</p>
        <h4><b>4. Putting it all together</b></h4>
        <p>We'll use<code> argparse </code>to take in our arguments, then run each step as detailed above.</p>
        <pre><code class="python">
import argparse
import requests
import getpass
import time


class APITutorial:
    def __init__(self, address, username):
        self.address = address
        self.username = username
        self.refresh_token = None
        self.auth_header = None
        self.is_connected = False

    def prompt_pass(self):
        ...

    def authenticate(self):
        ...

    def refresh(self):
        ...

    def check_workflow_exists(self, playbook_name, workflow_name):
        ...

    def execute_workflow(self, playbook_name, workflow_name):
        ...

    def trigger(self, execution_uids, data):
        ...

    def check_result(self, execution_uid):
        ...

    def logout(self):
        ...

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-a", "--address", type=str,
                        default="http://127.0.0.1:5000")
    parser.add_argument("-u", "--username", type=str,
                        default="admin")
    args = parser.parse_args()

    i = APITutorial(args.address, args.username)
    i.authenticate()
    i.refresh()
    i.check_workflow_exists("Tutorials", "Triggers")
    euid = i.execute_workflow("Tutorials", "Triggers")
    time.sleep(3)
    i.trigger([euid], "hi")
    time.sleep(3)
    i.check_result(euid)
    i.logout()


if __name__ == "__main__":
    main()
        </code></pre>
        <p>The sleep calls are to ensure that the server has enough time to start the workflow before we send the trigger data, and that it has enough time to completely execute the workflow before we check its results.</p>
        <p>This concludes the tutorial on the API's workflow execution, trigger, and results functions.</p>
        <h4><b>More in this series:</b></h4>
        <ol>
            <li><a href="Working_with_API_Auth.html">Using the API to authenticate with a WALKOFF instance.</a></li>
            <li><a href="Working_with_API_Query.html">Using the API to query a WALKOFF instance.</a></li>
      </ol>
    </div>

    <div class="w3-third w3-center">
        <i class="fa fa-graduation-cap w3-padding-64 w3-text-blue-grey"></i>
    </div>
    </div>
</div>
<div class="w3-container w3-black w3-center w3-opacity w3-padding-64">
    <h1 class="w3-margin w3-xlarge">Questions? Comments? </h1>
    <h1 class="w3-margin w3-xlarge"> Reach out to us at <a href="mailto:walkoff@nsa.gov"> walkoff@nsa.gov </a> </h1>
</div>

<!-- Footer -->
<footer class="w3-container w3-padding-64 w3-center w3-opacity">
 <!-- <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank"> </a></p> -->
</footer>

<script src="../../files/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script>
// Used to toggle the menu on small screens when clicking on the menu button
function myFunction() {
    var x = document.getElementById("navDemo");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else {
        x.className = x.className.replace(" w3-show", "");
    }
}
</script>
</body>
</html>

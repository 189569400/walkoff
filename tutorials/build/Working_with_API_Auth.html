<!DOCTYPE html>
<html>
<title>WALKOFF-Automation for All</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
<style>

body,h1,h2,h3,h4,h5,h6 {font-family: "Lato", sans-serif}
.w3-navbar,h1,button {font-family: "Montserrat", sans-serif}
.fa-graduation-cap,.fa-flask{font-size:200px}

#headerDiv{
    background-image:url("../../files/images/headerBackground2.png");
    background-size: 50% auto;
    background-repeat: no-repeat;
    background-position:50% 50%;
}

.imageList {
  list-style-type: none;
}

.topLevelList + h5{
  display:none;
}

.fa-circle, .fa-circle-o{
  font-size:12px;
  padding-right:10px;
}

.code{
    background-color:#edf0f4;
    padding:25px;
}


td{
    padding-right:10px;
    margin-bottom: 25px;
    margin-top:25px;
}

.image{
    text-align:center;
}

.image img{
    max-width:100%;
    max-height:100%;
}

.functionality_list li{
    margin-bottom:20px;
}

.tag{
    background-color:#edf0f4;
    text-align:center;
}

img.media-object.image{
    width:100%;
}

.tutorialTable td{
    border-bottom:1px solid black;
}

</style>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
    
<!-- Navbar -->
<div class="w3-top">
  <div class="w3-bar w3-blue-grey w3-card-2 w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-opennav w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
    <a href="../../index.html" class="w3-bar-item w3-button w3-padding-large w3-white">Home</a>
    <a href="../../documentation/build/index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Documentation</a>
    <a href="https://github.com/nsacyber/WALKOFF" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Source</a>
    <a href="../../swagger/index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">API</a>
    <a href="index.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Tutorials</a>
  </div>

  <!-- Navbar on small screens -->
  <div id="navDemo" class="w3-navblock w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
    <a class="w3-padding-large" href="../../documentation/build/index.html">Documentation</a>
    <a class="w3-padding-large" href="https://github.com/nsacyber/WALKOFF">Source</a>
    <a class="w3-padding-large" href="../../swagger/index.html">API</a>
    <a class="w3-padding-large" href="index.html">Tutorials</a>
  </div>
</div>

<!-- Header -->
<header id="headerDiv" class="w3-container w3-black w3-center w3-padding-64">
  <h1 class="headerText w3-margin w3-jumbo">WALKOFF</h1>
  <h5 class="headerText w3-margin w3-xxxlarge">Tutorials</h5>
</header>

<div class="w3-row-padding w3-padding-64 w3-container">
  <div class="w3-content">
    <div class="w3-twothird">
      <h1>Using the WALKOFF API (Authentication)</h1>
        <p>Although we have primarily used the playbook editor to launch and observe workflows thus far in these tutorials, in production we would normally either use the scheduler, or use the API outside of the playbook editor. In this tutorial, we will write a standalone Python script that demonstrates how to use WALKOFF's RESTful API to authenticate with a WALKOFF instance.</p>
        <p>At the end of this tutorial series, we will have developed a script that:</p>
        <ol>
            <li>Takes in address and username arguments for a WALKOFF instance.</li>
            <li>Attempts to authenticate with the WALKOFF instance at that address with the specified username, prompting for a password.</li>
            <li>Refreshs the access token.</li>
            <li>Lists the available workflows.</li>
            <li>If the workflow "Tutorial" exists, executes it.</li>
            <li>Checks the results of the workflow.</li>
            <li>Logs out.</li>
        </ol>
        <p>This part will detail steps 1, 2, 3, and 8.</p>
        <h4><b>1. Create a class for storing state</b></h4>
        <p>To start, we will create a class definition to store our session state.</p>
        <pre><code class="python">
class APITutorial:
    def __init__(self, address, username):
        self.address = address
        self.username = username
        self.refresh_token = None
        self.auth_header = None
        self.is_connected = False
        </code></pre>
        <h4><b>2. Authenticate with the WALKOFF instance</b></h4>
        <p>To begin, we will need to authenticate ourselves with the WALKOFF instance at <code>/api/auth</code> using a valid username and password. We will prompt for a password in console.</p>
        <pre><code class="python">
def prompt_pass(self):
    return getpass.getpass(
        prompt="Enter password for WALKOFF user {}@{}: ".format(
            self.username, self.address))

def authenticate(self):
    print("Authenticating...")
    r = requests.post(self.address + "/api/auth",
                      json=dict(username=self.username,
                                password=self.prompt_pass()),
                      timeout=2)

    if r.status_code == 201:
        r = r.json()
        self.refresh_token = r['refresh_token']
        self.auth_header = {'Authorization': 'Bearer {}'.format(
            r['access_token'])}
        self.is_connected = True
        print("Authenticated.")

    elif r.status_code == 401:
        print("Authentication Error.")

    elif r.status_code == 404:
        print("WALKOFF instance not found.")

    else:
        print("Unknown response: {}: {}".format(
            r.status_code, r.json()))

    return self.is_connected
        </code></pre>
        <p>The <code>/api/auth</code> endpoint takes a username/password object and returns an access token and refresh token. The refresh token is used to obtain new access tokens, and access tokens are used to verify whether a user is authorized to access a resource.</p>
        <h4><b>3. Refreshing Access Tokens</b></h4>
        <p>It is best practice to obtain a new access token before performing an action to ensure that it will be authorized. To do so, we will use the <code>/api/auth/refresh</code> endpoint.</p>
        <pre><code class="python">
def refresh(self):
    refreshed = False
    if self.is_connected:
        print("Refreshing access token..."),
        refresh_header = {'Authorization': 'Bearer {}'.format(
            self.refresh_token)}

        r = requests.post(self.address + "/api/auth/refresh",
                          headers=refresh_header,
                          timeout=2)

        if r.status_code == 201:
            r = r.json()
            self.auth_header = {'Authorization': 'Bearer {}'.format(
                r['access_token'])}

            print("Access token refreshed.")
            refreshed = True

        elif r.status_code == 401:
            print("Authentication Error.")

        elif r.status_code == 404:
            print("WALKOFF instance not found.")

        else:
            print("Unknown response: {}: {}".format(
                r.status_code, r.json()))

    return refreshed
        </code></pre>
        <p>The <code>/api/auth/refresh</code> endpoint requires that the authorization header is set with the refresh token, and returns a new access token.</p>
        <h4><b>4. Log out.</b></h4>
        <p>At the end of the session, we will use the <code>/api/auth/logout</code> endpoint to log out of the WALKOFF instance.</p>
            <pre><code class="python">
def logout(self):
    logged_out = False
    if self.is_connected:
        print("Logging out..."),
        r = requests.post(self.address + "/api/auth/logout",
                          headers=self.auth_header,
                          json=dict(refresh_token=self.refresh_token),
                          timeout=2)

        if r.status_code == 204:
            self.is_connected = False
            print("Logged out.")
            logged_out = True

        elif r.status_code == 400:
            print("Bad or missing refresh token.")

        else:
            print("Unknown response: {}: {}".format(
                r.status_code, r.json()))

    return logged_out
            </code></pre>
        <p>The <code>/api/auth/logout</code> endpoint requires that the authorization header is set with the refresh token.</p>
        <p>This concludes the tutorial on the API's authentication functions. In the next tutorial, we will look at querying Workflows.</p>
        <div align="center" style="border:1px solid blue">
            <h5><a href="Working_with_API_Query.html">Next >></a></h5>
        </div>
        <h4><b>More in this series:</b></h4>
        <ol>
            <li><a href="Working_with_API_Query.html">Using the API to query a WALKOFF instance.</a></li>
            <li><a href="Working_with_API_Execution.html">Using the API to execute a workflow.</a></li>
      </ol>
    </div>

    <div class="w3-third w3-center">
        <i class="fa fa-graduation-cap w3-padding-64 w3-text-blue-grey"></i>
    </div>
    </div>
</div>
<div class="w3-container w3-black w3-center w3-opacity w3-padding-64">
    <h1 class="w3-margin w3-xlarge">Questions? Comments? </h1>
    <h1 class="w3-margin w3-xlarge"> Reach out to us at <a href="mailto:walkoff@nsa.gov"> walkoff@nsa.gov </a> </h1>
</div>

<!-- Footer -->
<footer class="w3-container w3-padding-64 w3-center w3-opacity">
 <!-- <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank"> </a></p> -->
</footer>

<script src="../../files/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script>
// Used to toggle the menu on small screens when clicking on the menu button
function myFunction() {
    var x = document.getElementById("navDemo");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else {
        x.className = x.className.replace(" w3-show", "");
    }
}
</script>
</body>
</html>
